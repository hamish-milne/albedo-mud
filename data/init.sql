CREATE TABLE IF NOT EXISTS Event(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    etype TEXT NOT NULL,
    payload BLOB
) STRICT;

CREATE TABLE IF NOT EXISTS Map(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    payload BLOB
) STRICT;

CREATE TABLE IF NOT EXISTS Tile(
    tid INTEGER PRIMARY KEY,
    map INTEGER GENERATED ALWAYS AS (tid >> 32) VIRTUAL REFERENCES Map ON DELETE CASCADE,
    y INTEGER GENERATED ALWAYS AS ((tid >> 16) & 0xFFFF) VIRTUAL,
    x INTEGER GENERATED ALWAYS AS (tid & 0xFFFF) VIRTUAL,
    ttype INTEGER,
    payload BLOB
) STRICT;

CREATE INDEX IF NOT EXISTS TileIndex ON Tile (map, y, x);

CREATE TABLE IF NOT EXISTS Entity(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    parent INTEGER REFERENCES Entity ON DELETE CASCADE,
    tile INTEGER REFERENCES Tile ON DELETE RESTRICT,
    etype TEXT NOT NULL,
    epos INTEGER,
    payload BLOB,
    CONSTRAINT Parents CHECK (parent IS NULL OR tile IS NULL)
) STRICT;
